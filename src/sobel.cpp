#include "sobel.h"

const int _log2[] = {-1,0,1,-1,2,-1,-1,-1,3,-1,-1,-1,-1,-1,-1,-1,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,6};

const unsigned int _C[16][32] = {
        {2147483648u,1073741824u,536870912u,268435456u,134217728u,67108864u,33554432u,16777216u,8388608u,4194304u,2097152u,1048576u,524288u,262144u,131072u,65536u,32768u,16384u,8192u,4096u,2048u,1024u,512u,256u,128u,64u,32u,16u,8u,4u,2u,1u},
        {2147483648u,3221225472u,2684354560u,4026531840u,2281701376u,3422552064u,2852126720u,4278190080u,2155872256u,3233808384u,2694840320u,4042260480u,2290614272u,3435921408u,2863267840u,4294901760u,2147516416u,3221274624u,2684395520u,4026593280u,2281736192u,3422604288u,2852170240u,4278255360u,2155905152u,3233857728u,2694881440u,4042322160u,2290649224u,3435973836u,2863311530u,4294967295u},
        {2147483648u,3221225472u,1610612736u,2415919104u,3892314112u,1543503872u,2382364672u,3305111552u,1753219072u,2629828608u,3999268864u,1435500544u,2154299392u,3231449088u,1626210304u,2421489664u,3900735488u,1556135936u,2388680704u,3314585600u,1751705600u,2627492864u,4008611328u,1431684352u,2147543168u,3221249216u,1610649184u,2415969680u,3892340840u,1543543964u,2382425838u,3305133397u},
        {2147483648u,3221225472u,536870912u,1342177280u,4160749568u,1946157056u,2717908992u,2466250752u,3632267264u,624951296u,1507852288u,3872391168u,2013790208u,3020685312u,2181169152u,3271884800u,546275328u,1363623936u,4226424832u,1977167872u,2693105664u,2437829632u,3689389568u,635137280u,1484783744u,3846176960u,2044723232u,3067084880u,2148008184u,3222012020u,537002146u,1342505107u},
        {2147483648u,1073741824u,536870912u,3489660928u,3892314112u,4093640704u,570425344u,2432696320u,2826960896u,2537553920u,1302331392u,2798649344u,134742016u,872677376u,4194435072u,3171745792u,1755217920u,3028238336u,2186420224u,1093210112u,547522560u,3546117120u,1874254336u,3151719680u,511705216u,1061158976u,1914699808u,4178575568u,1250427368u,2842952692u,2497316642u,1248661393u},
        {2147483648u,1073741824u,1610612736u,805306368u,3355443200u,603979776u,1442840576u,4211081216u,3766484992u,1883242496u,2824863744u,338690048u,2663907328u,3743678464u,3067478016u,2344288256u,1207992320u,1677737984u,905994240u,3405787136u,679528448u,1413489664u,4267726336u,4012964608u,2118705280u,2942595136u,515287136u,2676692016u,3603439304u,3139739428u,2161563350u,1086045115u},
        {2147483648u,3221225472u,2684354560u,3489660928u,3355443200u,3959422976u,436207616u,3036676096u,545259520u,2428502016u,2829058048u,3704619008u,1103626240u,787218432u,966393856u,2809462784u,1207992320u,738246656u,973119488u,2768293888u,3364079616u,3973049344u,446634496u,3039606016u,2696487040u,1357353152u,145270944u,215801040u,163693000u,49213164u,2207881626u,3262609269u},
        {2147483648u,1073741824u,2684354560u,1342177280u,2281701376u,3288334336u,3791650816u,3036676096u,3665821696u,1212153856u,2686451712u,1343225856u,673710080u,2215903232u,3793879040u,3849388032u,1656258560u,4113383424u,2060886016u,1480724480u,671090688u,3288335360u,2717911552u,1358955776u,176162944u,2235571264u,3223326240u,3792706384u,4043849128u,445912196u,222964226u,3560011009u},
        {2147483648u,1073741824u,2684354560u,1342177280u,671088640u,3288334336u,3791650816u,3036676096u,3665821696u,4248829952u,2686451712u,269484032u,136839168u,2215903232u,705298432u,3312517120u,1622704128u,4121772032u,2060886016u,2918141952u,2818574336u,1409287168u,2852129280u,553649408u,2424308352u,1765809216u,882904608u,1515223888u,3666361768u,4249219028u,2687166978u,269660417u},
        {2147483648u,1073741824u,3758096384u,2952790016u,2550136832u,3288334336u,2717908992u,1996488704u,763363328u,3233808384u,538968064u,2416967680u,674758656u,2754347008u,2384855040u,2985361408u,2355658752u,3067985920u,1298882560u,3489673216u,4160751616u,2751464448u,1711279616u,922749696u,1585449344u,2613066816u,186661408u,4163954544u,3275264728u,154655756u,2025685506u,568822017u},
        {2147483648u,1073741824u,2684354560u,268435456u,134217728u,3288334336u,3791650816u,3036676096u,947912704u,3426746368u,538968064u,1343225856u,673710080u,67371008u,33685504u,1097924608u,3644358656u,2024620032u,430841856u,3697479680u,2281703424u,2483028992u,2717911552u,2499805440u,2994733184u,1212161088u,3802197536u,4061625168u,2199118728u,1116396740u,3101352450u,3612493057u},
        {2147483648u,1073741824u,536870912u,805306368u,1476395008u,3288334336u,570425344u,285212672u,1769996288u,2529165312u,3760193536u,3490709504u,3892838400u,2618032128u,2048262144u,3618701312u,1263042560u,2277785600u,2314887168u,3870666752u,1476397056u,3422553088u,2986344960u,3405775616u,2038433152u,2529176640u,945910304u,1956323600u,2172962456u,180787564u,2586873346u,128404737u},
        {2147483648u,3221225472u,2684354560u,1342177280u,4160749568u,1140850688u,2785017856u,1962934272u,3934257152u,868220928u,2686451712u,1882193920u,2552758272u,3021209600u,1514012672u,2362507264u,636059648u,3030204416u,3411714048u,60616704u,2550138880u,1006636032u,905972224u,1291846912u,2474643328u,2562749504u,1608751712u,615323472u,3020832424u,2048824124u,361773570u,1241212675u},
        {2147483648u,3221225472u,1610612736u,2415919104u,939524096u,3288334336u,1107296256u,2734686208u,4051697664u,2856321024u,4242538496u,2232418304u,3758620672u,1342963712u,1476788224u,1409875968u,2047049728u,1728856064u,3011780608u,155856896u,225384448u,794469376u,484953600u,3574878464u,3087007872u,67109056u,570425440u,855638160u,3380609080u,1849688260u,3202351170u,638582947u},
        {2147483648u,1073741824u,536870912u,4026531840u,2818572288u,1409286144u,1107296256u,1627389952u,2424307712u,1539309568u,4271898624u,2337275904u,2684878848u,1342439424u,671219712u,3423535104u,34242560u,2164604928u,3538165760u,960892928u,1872300032u,1351990272u,3738692096u,2603398400u,2281701504u,1140850752u,570425376u,4278190320u,2726297768u,1363148884u,639632962u,1729101921u},
        {2147483648u,3221225472u,536870912u,3489660928u,3623878656u,3288334336u,3254779904u,3808428032u,276824064u,3678404608u,1868562432u,823132160u,3758620672u,3490447360u,671219712u,3691839488u,3658317824u,3373023232u,3477872640u,3817746432u,2420180992u,2607657984u,3485398528u,1103565056u,2281701504u,1946157248u,3590324256u,3238002896u,3632267480u,3300917444u,3256880322u,3822111971u}
};

SobelGenerator::SobelGenerator() {
    cur = 128;
}

unsigned int SobelGenerator::get(unsigned int i) {
    unsigned int res = 0;
    for (int j = 0; j < bitDepth; j++)
        if (i & (1u << j))
            res ^= C[j];
    return res;
}

void SobelGenerator::gen() {
    buffer[0] = get(cur);
    for (int i = 1, las = 0; i < bufferSize; i++) {
        int gray = i ^ (i>>1);
        buffer[gray] = buffer[las] + C[_log2[gray^las]];
        las = gray;
    }
}

float SobelGenerator::operator()() {
    if ((cur&(bufferSize-1)) == 0)
        gen();
    return
            static_cast<float>(buffer[(cur++)&(bufferSize-1)])
            / static_cast<float>(UINT32_MAX);
}

SobelGroup::SobelGroup() : U(0.0f, 1.0f), mt(0) {
    for (int i = 0; i < groupSize; i++)
        for (int k = 0; k < SobelGenerator::bitDepth; k++)
            gen[i].C[k] = _C[i][k];
}

float SobelGroup::operator()() {
    return U(mt);
}

float SobelGroup::operator ()(int dimension) {
    return (dimension < groupSize) ? gen[dimension]() : U(mt);
}

float Generator::operator()() {
    return (*sobel)(dimension);
}